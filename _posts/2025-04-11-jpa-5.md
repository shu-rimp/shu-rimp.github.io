---
title: "[JPA #5] í˜ì¹˜ ì¡°ì¸ê³¼ JPQLì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥"
author: shurimp
date: 2025-04-11 17:46:00 +0900
categories: ["Backend", "DB"]
tags: [jpa,entity,hibernate,fetchjoin]
# ì´ë¯¸ì§€ ì‚½ì… ì‹œ ì•„ë˜ ì¤„ ì£¼ì„ ì œê±°
image: 
   path: posts/5-1.png
   alt: jpa
---

## ì£¼ìš” í‚¤ì›Œë“œ
- í˜ì¹˜ ì¡°ì¸(fetch join)
- ë‹¤í˜•ì„± ì¿¼ë¦¬
- Named ì¿¼ë¦¬
- ë²Œí¬ ì—°ì‚°

---

## í˜ì¹˜ ì¡°ì¸ (Fetch Join)

- `join fetch` ë¬¸ë²•ì„ ì‚¬ìš©
- JPQLì˜ `distinct`ëŠ” SQLì˜ `DISTINCT`ë¥¼ ì¶”ê°€í•  ë¿ ì•„ë‹ˆë¼, **ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì—”í‹°í‹° ì¤‘ë³µë„ ì œê±°**í•¨

### ì¼ë°˜ ì¡°ì¸ vs í˜ì¹˜ ì¡°ì¸

- ì¼ë°˜ ì¡°ì¸: ì—°ê´€ ì—”í‹°í‹°ë¥¼ **ì¦‰ì‹œ ì¡°íšŒí•˜ì§€ ì•ŠìŒ** â†’ ì´í›„ **ì§€ì—° ë¡œë”© ë°œìƒ**
- í˜ì¹˜ ì¡°ì¸: ì—°ê´€ ì—”í‹°í‹°ê¹Œì§€ **í•œ ë²ˆì— í•¨ê»˜ ì¡°íšŒ**

### í˜ì¹˜ ì¡°ì¸ì˜ íŠ¹ì§•ê³¼ í•œê³„

- í˜ì¹˜ ì¡°ì¸ ëŒ€ìƒì—ëŠ” **ë³„ì¹­ ì‚¬ìš© ë¶ˆê°€**  
  (*HibernateëŠ” ê°€ëŠ¥í•˜ë‚˜ ì‚¬ìš© ìì œ*)
- **ë‘ ê°œ ì´ìƒì˜ ì»¬ë ‰ì…˜ì€ í˜ì¹˜ ì¡°ì¸ ë¶ˆê°€**
- **ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ ì‹œ í˜ì´ì§• ì‚¬ìš© ë¶ˆê°€**
  - HibernateëŠ” ê²½ê³  ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê³  **ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§• ì²˜ë¦¬** â†’ ë§¤ìš° ìœ„í—˜

#### í•´ê²° ë°©ë²•

1. **ì¡°ì¸ ìˆœì„œ ì¡°ì •**  
   - xToMany â†’ xToOne ìˆœì„œë¡œ ë³€ê²½
2. **í˜ì¹˜ ì¡°ì¸ì„ ì œê±°í•˜ê³  í˜ì´ì§• í›„ ì§€ì—° ë¡œë”©**  
   - N+1 ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
3. **`@BatchSize` ì‚¬ìš©**  
   - ë‚´ë¶€ì ìœ¼ë¡œ IN ì¿¼ë¦¬ ì‚¬ìš©  
   - `persistence.xml`ì—ì„œ ì „ì—­ ì„¤ì • ê°€ëŠ¥ (ê¶Œì¥)
4. **ì¿¼ë¦¬ ì „ìš© DTOë¡œ ì¡°íšŒ**

> ğŸ“Œ í†µê³„ì„± ì¿¼ë¦¬ì²˜ëŸ¼ ì—”í‹°í‹°ì˜ êµ¬ì¡°ì™€ ì „í˜€ ë‹¤ë¥¸ ê²°ê³¼ê°€ í•„ìš”í•œ ê²½ìš°,  
> í˜ì¹˜ ì¡°ì¸ë³´ë‹¤ **ì¼ë°˜ ì¡°ì¸ + DTO ë§¤í•‘**ì´ ì í•©

---

## ë‹¤í˜•ì„± ì¿¼ë¦¬

### `type`

- íŠ¹ì • ìì‹ íƒ€ì…ë§Œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©

```sql
select i from Item i where type(i) IN (Book, Movie)
```

### `treat`

- íƒ€ì… ìºìŠ¤íŒ…ì²˜ëŸ¼ ë¶€ëª¨ â†’ ìì‹ìœ¼ë¡œ ì·¨ê¸‰

```sql
select i from Item i where treat(i as Book).author = 'Kim'
```

---

## ì—”í‹°í‹° ì§ì ‘ ì‚¬ìš©

- JPQLì—ì„œ ì—”í‹°í‹°ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ë©´ SQLë¡œ ë³€í™˜ ì‹œ **í•´ë‹¹ ì—”í‹°í‹°ì˜ PK**ê°€ ì‚¬ìš©ë¨

```sql
select m from Member m where m.team = :team  -- team_id ë¹„êµ
```

---

## Named ì¿¼ë¦¬ (`@NamedQuery`)

- ë¯¸ë¦¬ ì •ì˜í•œ ì •ì  ì¿¼ë¦¬ì— **ì´ë¦„ì„ ë¶€ì—¬**í•´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
- `@NamedQuery`, `orm.xml`ì— ì •ì˜ ê°€ëŠ¥
- **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì´ˆê¸°í™” ë° ì¿¼ë¦¬ ê²€ì¦** ìˆ˜í–‰
- ë„¤ì´ë° ê´€ë¡€: `"ì—”í‹°í‹°ëª….ì¿¼ë¦¬ëª…"`

```java
@NamedQuery(
  name = "Member.findByUsername",
  query = "select m from Member m where m.username = :username"
)
```

- Spring Data JPAì˜ `@Query`ë„ ë‚´ë¶€ì ìœ¼ë¡œ NamedQueryë¡œ ë“±ë¡ë¨

---

## ë²Œí¬ ì—°ì‚°

- JPAì˜ ë³€ê²½ ê°ì§€ë¡œëŠ” ë§ì€ ì—”í‹°í‹° ë³€ê²½ ì‹œ **ë¹„íš¨ìœ¨ì **
- ì§ì ‘ SQLì„ ì‹¤í–‰ â†’ `executeUpdate()` ì‚¬ìš©

```java
em.createQuery("update Member m set m.age = 20").executeUpdate();
```

- ì§€ì›: `update`, `delete` (`insert ... select`ëŠ” Hibernateë§Œ ê°€ëŠ¥)
- **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  DBì— ì§ì ‘ ë°˜ì˜**
  - ì´í›„ `em.clear()` ë“±ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” í•„ìš”

```java
em.flush();
em.clear();  // ë²Œí¬ ì—°ì‚° í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ê¶Œì¥
```

